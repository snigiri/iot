# Введение в IoT (семинары)

Этот репозиторий содержит установочные скрипты bash и документацию.

README - в данном руководстве описаны практические работы (ДЗ) по курсу "Введение в IOT". 

Онлайн университет: GeekBrains

Группа: Инженер умных устройств

Студент: Ростислав Ромашин 

## Урок 1. Развертывание своей системы визуализации

Все описанное в разделе выполнялась на операционной системе Ubuntu 22.04.3 LTS с использованием Docker version 24.0.6 build ed223bc.

Все действия рекомендую проводить от имени суперпользователя root.

### Быстрый старт

Копируем команду представленную ниже и вставляем в терминал системы.

```
wget https://github.com/allseenn/iot/raw/main/install.sh -O install.sh && bash install.sh
```

В результате запустится скрипт развертывания системы на основе docker контейнеров:

- mosquitto
- telegraf
- influxdb
- grafana
- node-red
- wireguard

Логин и пароль для всех служб по умолчанию одинаковый, во избежании путаницы:
- user: admin
- pass: students

ВНИМАНИЕ: Из-за требований безопасности одной из служб общий пароль должен быть не менее 8 символов. Поэтому students - во множественном числе с **s** на конце.

После установки, через веб-браузер заходим на адреса, которые будут опубликованы скриптом перед завершением работы.

Порты для служб по умолчанию:
- mosquitto 1883/tcp
- telegraf 8092/udp, 8125/udp, 8094/tcp
- influxdb 8080/tcp
- grafana 3000/tcp
- node-red 1880/tcp
- wireguard 51820/udp

Вся служебная информация: логины, пароли, адреса и порты, токены, будет сохранена в файле ~/info.txt после завершения скрипта установки.

### Описание

Предлагаю два скрипта:

- install.sh
- uninstall.sh

#### install.sh

Установочный bash скрипт в начале кода содержит константы, которые можно изменить по своему усмотрению:

- USERNAME - имя пользователя, одинаковое для всех служб
- PASSWORD - пароль не менее 8 символов, одинаковый для всех служб
- ORG - организация
- BUCKET - корзина
- INFLUXDB_TOKEN - токен базы InfluxDB

Вышеперечисленные константы можно оставить по умолчанию.

Константы перечисленные ниже:

- LOC_IP - локальный ip-адрес
- PUB_IP - публичный ip-адрес
- ALL_IP - маска, означающая - все адреса
- DOCKER_VERSION - требуемая версия докера, если версия ниже, то происходит автоматическое обновление до последней.

Значение последних четырех констант вычисляются автоматически, но могут быть откорректированы на свое усмотрение.

Загрузить скрипт на систему Ubuntu можно несколькими способами:
- с помощью git
- wget, curl
- copy & pase

В любом случае, после сохранения скриптов на свою систему, необходимо выставить на них бит исполнения:

```
chmod 700 *.sh
./install.sh
```

Либо запускать скрипт как аргумент интерпретатора:

```
bash install.sh
```

Первым делом  скрипт install.sh проверит наличие docker и его версию, в случае отсутствия либо низкой версии программы, будет произведена установка.

Скрипт автоматически создаст в домашней директории пользователя (в случае рута в /root) структуру каталогов и в них конфигурационные файлы, которые автоматически будут примонтированы к соответствующим докер контейнерам.

В конце работы скрипта будет выведена информация о локальных, публичных адресах и о портах каждой службы.

Проброс портов через роутер в данном руководстве не рассматривается, предполагается, что вы знакомы с курсом "Компьютерные сети".

Так же будет создано несколько конфигураций для ВПН WireGuard. И в терминал будет выведен QR-код клиента.

Информация по настройке и установке WireGuard клиента не рассматривается, а может быть получена с [оффсайта](https://www.wireguard.com/quickstart/).

<img src=pics/01.png>

**На рисунке показан пример финального вывода служебной информации установочного скрипта install.sh**

В результате работы install.sh будет произведен деплой полностью рабочей системы. С настроенными паролями для каждой службы.

Более того, с помощью API графаны мне удалось создать datasource источник подключения к influxdb.

Скорее всего всю работу проведенную в первом занятии по настройке и визуализации можно сделать с помощью API служб и их команд. Но, это следующий этап )



#### uninstall.sh

Скрипт деинсталляции, позволяет полностью удалить развернутые контейнеры их конфиги и виртуальные сетевые интерфейсы.

В процессе экспериментов и настройки установочного скрипта, для ускорения процесса разработки использовал команду:

```
./uninstall.sh && ./install.sh
```
Это позволяет одной строкой удалить старый набор контейнеров и установить новый измененный.


### Скрины

#### Mosquitto

Зайдя в shell контейнера mosquitto, можно отправлять mqtt события из терминала. 

```
$ docker exec -it mosquitto sh
/ # mosquitto_pub -h 192.168.1.8 -p 1883 -t "GB/Temp" -m "28.5" -u "admin" -P "students"

```

<img src=pics/02.png>

#### Telegraf

Телеграф прослушивает заданные в его конфиге топики и записывает события в базу InfluxDB:

<img src=pics/00.png>

#### InfluxDB

После того, как мы послали через терминал mosquitto несколько событий, телеграф их записал в базу, зайдя в вебку InfluxDB, выбираем внизу в столбце FROM наш подключенный bucket IoT, во втором столбце выбираем из выпадающего списка _measurement и прокрутив вниз ставим галку на mqtt_consumer, в третьем столбце вибираем из списка topic и ниже наблюдаем в списке топиков на GB\topic (т.е. тут мажно передавать имя устройства, например arduino001), в четвертом столбце выбрав из списка host ниже появится айдишник хоста, поставим на нем галку жмем кнопку SUBMIT и у нас появляется график с точкой или точками. Нажмем рядом на кнопку SCRIPT EDITOR, открывается окно запросов с кодом, который можно скопировать и вставить в дашборт Графаны, чтобы она именно по этому запросу отрисовывала нужные нам показатели конкретного устройства, чтобы обратно вернуться к столбцам, нужно нажать кнопку QUERY BUILDER: 

<img src=pics/03.png>

Информацию можно визуализировать различными способами, такими как графики, спидометры или гистограммы:

<img src=pics/04.png>

Обратил внимание, что докер контейнеры, благодаря правильной настройке, также скидывают свои метрики в базу, так можно наблюдать общую загрузку процессора у каждого контейнера:

<img src=pics/05.png>

Запрос influxdb можно скопировать для последующего отображения в grafana:

<img src=pics/06.png>

#### Grafana

Благодаря API Grafana мы автоматически создали подключение к базе InfluxDB и оно уже присутствует в нашей системе:

<img src=pics/07.png>

Остается только выбрать подключенный источник данных:

<img src=pics/08.png>

И вставить, скопированный ранее, из InfluxDB запрос:
```
from(bucket: "IoT")
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "mqtt_consumer")
  |> filter(fn: (r) => r["_field"] == "value")
  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
  |> yield(name: "mean")
```

<img src=pics/09.png>

Отобразится графическая информация сгенерированная с помощью mosquitto, но средствами Grafana, вид представления можно поменять на спидометр, таблицу и др.:

<img src=pics/10.png>

Сохранив данное представление, получим готовый дашборд.

#### Node-red

Установим палитру для случайной генерации чисел:

<img src=pics/11.png>

Подключив элемент отладки при нажатии на кнопку метки времени, в правой панели наблюдаем порядковый номер действия:

<img src=pics/12.png>

Добавим элемент Random Number и зададим его параметры:

<img src=pics/13.png>

Добавим элемент mqtt-out и настроим его параметры, с помощью двойного клика по нашему элементу:

<img src=pics/14.png>

Для элемента mqqt-out введем параметры безопасности:

<img src=pics/15.png>

Настроим для mqtt-out тему и QoS:

<img src=pics/16.png>

Добавив элемент mqtt-in, настроим его параметры:

<img src=pics/17.png>

Настроим хранилище InfluxDB out:

<img src=pics/18.png>

Зададим параметры для Organization и Bucket:

<img src=pics/19.png>

После нажатия кнопки "Развернуть" (Deploy), сетевые элементы входа и выхода изменили статус на "подключено":

<img src=pics/20.png>

### Заключение

В результате произведенных действий в Node-Red, мы видим новые данные в базе InfluxDB:

<img src=pics/21.png>

Сгенерируем больше случайных событий в Node-Red:

<img src=pics/22.png>

Все эти действия зафиксированы в базе:

<img src=pics/23.png>

Node-Red позволяет в разрез элементов вставлять функции написанные на JavaScript:

<img src=pics/24.png>

А установка новых палитр позволяет расширить функционал и набор поддерживаемого оборудования.

Подключил палитру node-red-node-serailport, с помощью нее попробую подключить устройство, купленный ранее термодатчик, для выполнения второго задания.



